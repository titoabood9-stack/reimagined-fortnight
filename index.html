<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>عرض — صور / سجل مكالمات / موقع</title>
<style>
  body{font-family:Tahoma,Arial;direction:rtl;padding:14px;background:#f6f8fb;color:#111;margin:0}
  .card{max-width:900px;margin:10px auto;background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h1{margin:0 0 8px;color:#0b63a8;font-size:1.5rem}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button, .btn{padding:8px 12px;border-radius:8px;border:0;background:#1976d2;color:#fff;cursor:pointer;text-align:center;font-size:14px;display:inline-block;text-decoration:none}
  button.ghost, .btn.ghost{background:#fff;color:#1976d2;border:1px solid #1976d2}
  .muted{color:#666;font-size:14px}
  #map{width:100%;height:260px;border-radius:8px;border:1px solid #e0e0e0;margin-top:10px;display:flex;align-items:center;justify-content:center;background:#f9f9f9}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:10px}
  .thumb{height:110px;overflow:hidden;border-radius:8px;background:#eee;display:flex;align-items:center;justify-content:center}
  textarea{width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #ddd;font-family:inherit;box-sizing:border-box}
  .note{font-size:13px;color:#444;margin-top:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px;display:none}
  th, td{padding:10px;text-align:right;border-bottom:1px solid #eee}
  thead{background:#f2f2f2}
  #fileImg{display:none}
  @media (max-width: 600px) {
    .card{padding:10px}
    h1{font-size:1.3rem}
    button, .btn{width:100%;margin-bottom:5px}
    .row{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="card">
    <h1>عرض: صور — سجل المكالمات — الموقع</h1>
    <p class="muted">هذه صفحة تعرض صور (رفع أو كاميرا)، تُظهر الموقع بعد الموافقة، ويمكنك لصق سجل المكالمات لعرضه. لا تزال كل خطوة بيدك (موافقة/رفع).</p>

    <div class="row">
      <button id="btnGetLoc">اطلب الموقع & اعرض الخريطة</button>
      <button id="btnOpenCam">افتح الكاميرا (التصوير فوري)</button>
      <label for="fileImg" class="btn ghost">رفع صور من الجهاز</label>
      <input id="fileImg" type="file" accept="image/*" multiple>
      <button id="btnClear" class="ghost">مسح العرض</button>
    </div>

    <div id="map" class="muted">الخريطة ستظهر هنا بعد السماح للموقع.</div>

    <h3 style="margin-top:12px">الصور</h3>
    <div id="imgGrid" class="grid">
      <!-- thumbs -->
    </div>

    <h3 style="margin-top:12px">كاميرا مباشرة (إن سمحت)</h3>
    <video id="camPreview" autoplay playsinline style="width:100%;max-height:360px;border-radius:8px;background:#000;display:none"></video>
    <div class="row" style="margin-top:8px">
      <button id="btnSnap" class="ghost" style="display:none">التقط صورة</button>
    </div>

    <h3 style="margin-top:12px">سجل المكالمات (انسخ والصقه هنا)</h3>
    <p class="muted">انسخ من سجل المكالمات أو اكتب بعض الأسطر لتمثيل البيانات؛ سيظهر تلقائياً.</p>
    <textarea id="callsInput" placeholder="مثال: اسم,رقم,نوع(واردة/صادرة/فائتة),مدة(ث),2025-09-23 10:12&#10;أبو خالد,+971501234567,واردة,120,2025-09-23 10:12"></textarea>
    <div class="row">
      <button id="btnParse">عرض سجل المكالمات</button>
      <button id="btnClearCalls" class="ghost">مسح السجل</button>
    </div>

    <table id="callsTable">
      <thead><tr><th>الاسم</th><th>الرقم</th><th>النوع</th><th>المدة (ث)</th><th>التاريخ</th></tr></thead>
      <tbody></tbody>
    </table>

    <p class="note">ملاحظة: صفحة الويب لا تستطيع الوصول تلقائياً لسجل المكالمات أو صور الجهاز دون موافقتك أو تطبيق مثبت — هذه الطريقة تضمن توضيح الفكرة بطريقة قانونية وآمنة.</p>
  </div>

<script>
/* عناصر */
const btnGetLoc = document.getElementById('btnGetLoc');
const mapDiv = document.getElementById('map');
const fileImg = document.getElementById('fileImg');
const imgGrid = document.getElementById('imgGrid');
const btnOpenCam = document.getElementById('btnOpenCam');
const camPreview = document.getElementById('camPreview');
const btnSnap = document.getElementById('btnSnap');
const btnClear = document.getElementById('btnClear');
const callsInput = document.getElementById('callsInput');
const btnParse = document.getElementById('btnParse');
const callsTable = document.getElementById('callsTable');
const callsBody = callsTable.querySelector('tbody');
const btnClearCalls = document.getElementById('btnClearCalls');

let streamRef = null;

/* الموقع */
btnGetLoc.addEventListener('click', ()=> {
  if (!navigator.geolocation) {
    mapDiv.innerText = 'المتصفح لا يدعم الموقع.';
    return;
  }
  mapDiv.innerText = 'جاري طلب الموقع — راجع الإذن في المتصفح...';
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    mapDiv.innerHTML = `<iframe width="100%" height="100%" style="border:0" src="https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=${lat},${lon}&zoom=15&maptype=roadmap"></iframe>
      <div style="margin-top:6px;font-size:14px;color:#333">خط العرض: ${lat} — خط الطول: ${lon} — دقة ≈ ${pos.coords.accuracy} متر</div>`;
  }, err => {
    let errorMsg = 'تم رفض الموقع أو حصل خطأ: ';
    switch(err.code) {
      case err.PERMISSION_DENIED:
        errorMsg += 'تم رفض الإذن من قبل المستخدم.';
        break;
      case err.POSITION_UNAVAILABLE:
        errorMsg += 'معلومات الموقع غير متوفرة.';
        break;
      case err.TIMEOUT:
        errorMsg += 'انتهت مهلة طلب الموقع.';
        break;
      default:
        errorMsg += 'خطأ غير معروف.';
        break;
    }
    mapDiv.innerHTML = <div style="padding:20px;text-align:center">${errorMsg}</div>;
  }, {enableHighAccuracy:true, timeout:10000});
});

/* رفع صور */
fileImg.addEventListener('change', ev => {
  const files = Array.from(ev.target.files).slice(0,10);
  imgGrid.innerHTML = '';
  files.forEach(f=>{
    if (!f.type.startsWith('image/')) {
      alert(الملف ${f.name} ليس صورة. سيتم تخطيه.);
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const d = document.createElement('div');
      d.className = 'thumb';
      d.innerHTML = <img src="${reader.result}" style="width:100%;height:100%;object-fit:cover" alt="صورة محملة">;
      imgGrid.appendChild(d);
    };
    reader.onerror = () => {
      alert(خطأ في قراءة الملف: ${f.name});
    };
    reader.readAsDataURL(f);
  });
});

/* الكاميرا */
btnOpenCam.addEventListener('click', async ()=>{
  if (camPreview.style.display === 'none') {
    try {
      const constraints = { 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }, 
        audio: false 
      };
      
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      streamRef = s;
      camPreview.srcObject = s;
      camPreview.style.display = 'block';
      btnSnap.style.display = 'inline-block';
      btnOpenCam.innerText = 'أغلق الكاميرا';
    } catch(e) {
      alert('فشل فتح الكاميرا: ' + (e.message||e));
    }
  } else {
    // اغلاق
    if (streamRef) {
      streamRef.getTracks().forEach(t=>t.stop());
      streamRef = null;
    }
    camPreview.style.display = 'none';
    btnSnap.style.display = 'none';
    btnOpenCam.innerText = 'افتح الكاميرا (التصوير فوري)';
  }
});

btnSnap.addEventListener('click', ()=>{
  if (!streamRef) return;
  const video = camPreview;
  const w = video.videoWidth, h = video.videoHeight;
  if (w === 0 || h === 0) {
    alert('الكاميرا غير جاهزة بعد. انتظر قليلاً ثم حاول مرة أخرى.');
    return;
  }
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  c.getContext('2d').drawImage(video,0,0,w,h);
  const data = c.toDataURL('image/jpeg', 0.85);
  const d = document.createElement('div');
  d.className = 'thumb';
  d.innerHTML = <img src="${data}" style="width:100%;height:100%;object-fit:cover" alt="صورة من الكاميرا">;
  imgGrid.prepend(d);
});

/* مسح العرض */
btnClear.addEventListener('click', ()=>{
  imgGrid.innerHTML = '';
  mapDiv.innerHTML = 'الخريطة ستظهر هنا بعد السماح للموقع.';
  if (streamRef) {
    streamRef.getTracks().forEach(t=>t.stop());
    streamRef = null;
  }
  camPreview.style.display = 'none';
  btnSnap.style.display = 'none';
  btnOpenCam.innerText = 'افتح الكاميرا (التصوير فوري)';
  fileImg.value = '';
  callsInput.value = '';
  callsBody.innerHTML = '';
  callsTable.style.display = 'none';
  
  // إعادة الصور التوضيحية
  initPlaceholders();
});

/* معالجة سجل المكالمات من نص منسوخ */
btnParse.addEventListener('click', ()=>{
  const txt = callsInput.value.trim();
  if (!txt) { 
    alert('الصق أو أدخل بيانات السجل أولاً'); 
    return; 
  }
  
  // نتوقع أسطر مفصولة بسطر جديد، كل سطر: name,number,type,duration,date
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  callsBody.innerHTML = '';
  
  if (lines.length === 0) {
    alert('لا توجد بيانات صالحة للعرض');
    return;
  }
  
  lines.forEach((line, index)=>{
    const parts = line.split(',');
    if (parts.length < 5) {
      console.warn(السطر ${index+1} غير مكتمل: ${line});
      return;
    }
    
    const name = (parts[0]||'—').trim();
    const number = (parts[1]||'—').trim();
    const type = (parts[2]||'—').trim();
    const dur = (parts[3]||'0').trim();
    const date = (parts[4]||'—').trim();
    
    const tr = document.createElement('tr');
    tr.innerHTML = <td>${escapeHtml(name)}</td><td>${escapeHtml(number)}</td><td>${escapeHtml(type)}</td><td>${escapeHtml(dur)}</td><td>${escapeHtml(date)}</td>;
    callsBody.appendChild(tr);
  });
  
  callsTable.style.display = 'table';
});

/* مسح السجل */
btnClearCalls.addEventListener('click', ()=> {
  callsInput.value = '';
  callsBody.innerHTML = '';
  callsTable.style.display = 'none';
});

/* مساعدة: تهرب HTML نص */
function escapeHtml(s){ 
  if (typeof s !== 'string') return '';
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
}

/* عند فتح الصفحة تلقائياً نعرض أي صور افتراضية صغيرة */
function initPlaceholders(){
  imgGrid.innerHTML = '';
  const svg1 = 'data:image/svg+xml;utf8,' + encodeURIComponent(<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='#e0e0e0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#666' font-size='20'>صورة توضيحية</text></svg>);
  const svg2 = 'data:image/svg+xml;utf8,' + encodeURIComponent(<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='#ffe0b2'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#666' font-size='20'>مثال صورة</text></svg>);
  [svg1,svg2].forEach(src=>{
    const d = document.createElement('div'); 
    d.className='thumb'; 
    d.innerHTML = <img src="${src}" style="width:100%;height:100%;object-fit:cover" alt="صورة توضيحية">; 
    imgGrid.appendChild(d);
  });
}

// تهيئة الصفحة عند التحميل
document.addEventListener('DOMContentLoaded', function() {
  initPlaceholders();
});
</script>
</body>
</html>
